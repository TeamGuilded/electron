From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Alex Ciarlillo <alex.ciarlillo@gmail.com>
Date: Thu, 23 Mar 2023 12:15:58 -0400
Subject: add prepare web contents creation delegate for native window open

Guilded Patch: Offscreen Windows
Original Author: Chevon C

diff --git a/content/browser/web_contents/web_contents_impl.cc b/content/browser/web_contents/web_contents_impl.cc
index e49ccf4ffc115a78abceeddd7f452aeeb5c6a917..8a1c5e57b53e3e91da5fe591f38c0d498c8d8de7 100644
--- a/content/browser/web_contents/web_contents_impl.cc
+++ b/content/browser/web_contents/web_contents_impl.cc
@@ -4492,6 +4492,9 @@ FrameTree* WebContentsImpl::CreateNewWindow(
   if (!new_contents) {
     if (!is_guest) {
       create_params.context = view_->GetNativeView();
+      if (delegate_){
+        delegate_->OnPrepareWebContentsCreation(create_params, params);
+      }
       new_contents = WebContentsImpl::Create(create_params);
     } else {
       new_contents =
diff --git a/content/public/browser/web_contents_delegate.h b/content/public/browser/web_contents_delegate.h
index 8e15506e7c2da40a1288554d2b75d2c0951f07ad..cd694d13826a2e0800eb0d53d24b6ad24a109b67 100644
--- a/content/public/browser/web_contents_delegate.h
+++ b/content/public/browser/web_contents_delegate.h
@@ -70,6 +70,12 @@ struct NativeWebKeyboardEvent;
 struct Referrer;
 }  // namespace content
 
+namespace content {
+namespace mojom {
+class CreateNewWindowParams;
+}
+}
+
 namespace device {
 namespace mojom {
 class GeolocationContext;
@@ -351,6 +357,11 @@ class CONTENT_EXPORT WebContentsDelegate {
       const mojom::CreateNewWindowParams& params,
       WebContents* new_contents);
 
+  // Allows the delegate to control how created web contents params are constructed
+  virtual void OnPrepareWebContentsCreation(
+    content::WebContents::CreateParams& contentsCreateParams,
+    const content::mojom::CreateNewWindowParams& windowCreateParams) {}
+
   // Notifies the delegate about the creation of a new WebContents. This
   // typically happens when popups are created.
   virtual void WebContentsCreated(WebContents* source_contents,
